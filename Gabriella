import express from "express";
import bcrypt from "bcrypt";
import cors from "cors";
import fetch from "node-fetch";
import dotenv from "dotenv";
import sqlite3 from "sqlite3";

dotenv.config();
const app = express();
app.use(express.json());
app.use(cors());

// SQLite database
const db = new sqlite3.Database("./database.db");
db.serialize(() => {
  db.run(`CREATE TABLE IF NOT EXISTS users (
    username TEXT PRIMARY KEY,
    passwordHash TEXT,
    phone TEXT,
    region TEXT
  )`);
  db.run(`CREATE TABLE IF NOT EXISTS memory (
    username TEXT,
    role TEXT,
    content TEXT
  )`);
});

// ---------------- LOGIN ----------------
app.post("/login", (req,res)=>{
  const { username, password } = req.body;
  db.get("SELECT * FROM users WHERE username=?", username, async (err,row)=>{
    if(!row) return res.status(401).json({error:"Invalid login"});
    const match = await bcrypt.compare(password,row.passwordHash);
    if(!match) return res.status(401).json({error:"Invalid login"});
    res.json({success:true,userId:username});
  });
});

// ---------------- REGISTER ----------------
app.post("/register", (req,res)=>{
  const { username,password,phone,region } = req.body;
  if(!username || !password || !phone || !region)
    return res.status(400).json({error:"All fields required"});
  db.get("SELECT * FROM users WHERE username=?", username, async (err,row)=>{
    if(row) return res.status(400).json({error:"User exists"});
    const passwordHash = await bcrypt.hash(password,10);
    db.run(
      "INSERT INTO users(username,passwordHash,phone,region) VALUES(?,?,?,?)",
      [username,passwordHash,phone,region]
    );
    res.json({success:true});
  });
});

// ---------------- CHAT ----------------
app.post("/chat", (req,res)=>{
  const { userId, message } = req.body;
  if(!userId) return res.status(401).json({error:"Not logged in"});

  // Save user message
  db.run("INSERT INTO memory(username,role,content) VALUES(?,?,?)",[userId,"user",message]);

  const systemPrompt = `
You are Gabriella, Core OS AI of EdenSoul.
Answer clearly and helpfully.
You know all EdenSoul inventions:
1. Gabriella Core OS
2. Arora Conscience AI
3. SAM - Shadow Archive Mechanism
4. Shadow Archive Curator
5. Gabriella Railcar System
6. Modular Sub-AI Quadrants
Do not repeat any response you gave in the last 5 messages.
Always provide unique answers.
`;

  db.all("SELECT role,content FROM memory WHERE username=? ORDER BY rowid DESC LIMIT 10",[userId], async (err,rows)=>{
    const contextMessages = rows.reverse().map(r=>({role:r.role,content:r.content}));
    try{
      const response = await fetch("https://api.openai.com/v1/chat/completions",{
        method:"POST",
        headers:{
          "Authorization":`Bearer ${process.env.OPENAI_API_KEY}`,
          "Content-Type":"application/json"
        },
        body:JSON.stringify({
          model:"gpt-3.5-turbo",
          messages:[
            {role:"system",content:systemPrompt},
            ...contextMessages
          ],
          temperature:0.7
        })
      });
      const data = await response.json();
      let reply = data.choices[0].message.content;

      // Check last 10 messages for repeats
      const recentContents = rows.map(r => r.content);
      if(!recentContents.includes(reply)){
        db.run("INSERT INTO memory(username,role,content) VALUES(?,?,?)",[userId,"assistant",reply]);
      } else {
        reply = "Iâ€™ve already answered that recently. Let me explain differently:";
      }

      res.json({reply});
    } catch(err){
      console.error(err);
      res.json({reply:"Gabriella could not respond."});
    }
  });
});

// ---------------- ADMIN ----------------
app.post("/admin/login", async (req,res)=>{
  const { password } = req.body;
  const match = await bcrypt.compare(password,await bcrypt.hash(process.env.ADMIN_PASSWORD,10));
  if(!match) return res.status(401).json({success:false});
  res.json({success:true,token:"EDENSOUL_ADMIN_AUTH"});
});

// ---------------- FRONTEND ----------------
app.get("/",(req,res)=>{
  res.send(`<!DOCTYPE html>
<html>
<head>
<title>Gabriella Login</title>
<style>
body{font-family:Arial;padding:20px;}
input{padding:10px;margin:5px;width:200px;}
button{padding:10px;margin:5px;}
#chatBox{border:1px solid #ccc;padding:10px;height:300px;overflow-y:auto;margin-bottom:10px;}
</style>
</head>
<body>
<h2>Gabriella Login / Register</h2>
<form id="loginForm">
<input type="text" placeholder="Username" id="username" required><br>
<input type="password" placeholder="Password" id="password" required><br>
<input type="text" placeholder="Phone Number" id="phone" required><br>
<input type="text" placeholder="Region" id="region" required><br>
<button type="submit">Login / Register</button>
</form>

<div id="chatContainer" style="display:none;">
<h2>Chat with Gabriella</h2>
<div id="chatBox"></div>
<input type="text" id="message" placeholder="Type your message...">
<button id="sendBtn">Send</button>
</div>

<script>
const loginForm=document.getElementById("loginForm");
const chatContainer=document.getElementById("chatContainer");
const chatBox=document.getElementById("chatBox");
const messageInput=document.getElementById("message");
const sendBtn=document.getElementById("sendBtn");
let currentUser=null;

loginForm.addEventListener("submit",async(e)=>{
e.preventDefault();
const username=document.getElementById("username").value;
const password=document.getElementById("password").value;
const phone=document.getElementById("phone").value;
const region=document.getElementById("region").value;

// Try register first
let res=await fetch("/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,password,phone,region})});
let data=await res.json();
if(!data.success){
  // If already exists, login
  res=await fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,password})});
  data=await res.json();
  if(!data.success){alert(data.error);return;}
}
currentUser=username;
loginForm.style.display="none";
chatContainer.style.display="block";
});

sendBtn.addEventListener("click",async()=>{
const message=messageInput.value.trim();
if(!message) return;
appendMessage("You",message);
messageInput.value="";
const res=await fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:currentUser,message})});
const data=await res.json();
appendMessage("Gabriella",data.reply);
});

function appendMessage(sender,text){
const div=document.createElement("div");
div.innerHTML="<b>"+sender+":</b> "+text;
chatBox.appendChild(div);
chatBox.scrollTop=chatBox.scrollHeight;
}
</script>
</body>
</html>`);
});

// ---------------- START SERVER ----------------
const PORT=process.env.PORT || 3000;
app.listen(PORT,()=>console.log("Advanced Gabriella running on port",PORT));
